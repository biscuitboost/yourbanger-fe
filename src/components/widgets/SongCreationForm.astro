---
const OCCASIONS = [
  { value: 'birthday', label: 'Birthday', emoji: 'ğŸ‚' },
  { value: 'anniversary', label: 'Anniversary', emoji: 'ğŸ’' },
  { value: 'wedding', label: 'Wedding', emoji: 'ğŸ’’' },
  { value: 'retirement', label: 'Retirement', emoji: 'ğŸ‘”' },
  { value: 'fathers_day', label: "Father's Day", emoji: 'ğŸ‘¨' },
  { value: 'mothers_day', label: "Mother's Day", emoji: 'ğŸ‘©' },
  { value: 'thank_you', label: 'Thank You', emoji: 'ğŸ™' },
  { value: 'memorial', label: 'Memorial', emoji: 'ğŸ•Šï¸' },
]

const VIBES = [
  { value: 'uplifting', label: 'Uplifting', emoji: 'ğŸŒŸ' },
  { value: 'romantic', label: 'Romantic', emoji: 'ğŸ’•' },
  { value: 'heartfelt', label: 'Heartfelt', emoji: 'ğŸ’' },
  { value: 'funny', label: 'Funny', emoji: 'ğŸ˜„' },
  { value: 'energetic', label: 'Energetic', emoji: 'âš¡' },
  { value: 'nostalgic', label: 'Nostalgic', emoji: 'ğŸŒ…' },
]

const STYLES = [
  { value: 'pop', label: 'Pop', emoji: 'ğŸµ' },
  { value: 'acoustic', label: 'Acoustic', emoji: 'ğŸ¸' },
  { value: 'rnb', label: 'R&B', emoji: 'ğŸ¤' },
  { value: 'country', label: 'Country', emoji: 'ğŸ¤ ' },
  { value: 'rock', label: 'Rock', emoji: 'ğŸ¸' },
  { value: 'soul', label: 'Soul', emoji: 'ğŸ·' },
]

const VOCALS = [
  { value: 'm', label: 'Male Voice', emoji: 'ğŸ‘¨' },
  { value: 'f', label: 'Female Voice', emoji: 'ğŸ‘©' },
]

const STEPS = [
  { id: 'occasion', title: 'Occasion', icon: 'ğŸ' },
  { id: 'recipients', title: 'Recipients', icon: 'âœ¨' },
  { id: 'music', title: 'Music Style', icon: 'ğŸµ' },
  { id: 'details', title: 'Song Details', icon: 'âœ¨' },
]
---

<div class="max-w-2xl mx-auto" id="song-form">
  <!-- Restore Prompt (hidden by default, shown by JS) -->
  <div id="restore-prompt" class="mb-6 p-4 bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-800 rounded-lg hidden">
    <div class="flex items-start gap-3">
      <span class="text-2xl">ğŸ’¾</span>
      <div class="flex-1">
        <h3 class="font-semibold text-blue-900 dark:text-blue-100 mb-1">
          Continue where you left off?
        </h3>
        <p class="text-sm text-blue-700 dark:text-blue-300 mb-3">
          We found your previous song creation progress.
        </p>
        <div class="flex gap-2">
          <button
            id="restore-btn"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors"
          >
            Restore Progress
          </button>
          <button
            id="dismiss-btn"
            class="px-4 py-2 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm font-medium rounded-lg border border-gray-300 dark:border-gray-600 transition-colors"
          >
            Start Fresh
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Progress Steps -->
  <div class="mb-8">
    <div class="flex justify-between items-center">
      {STEPS.map((step, index) => (
        <div class="flex items-center">
          <div
            class={`step-indicator flex items-center justify-center w-10 h-10 rounded-full border-2 transition-colors ${
              index === 0 ? 'border-[var(--primary)] bg-[var(--primary)] text-white' : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-400'
            }`}
            data-step={index}
          >
            <span class="text-lg">{step.icon}</span>
          </div>
          {index < STEPS.length - 1 && (
            <div
              class={`step-line w-[60px] h-1 mx-2 ${index === 0 ? 'bg-gray-300 dark:bg-gray-600' : 'bg-gray-300 dark:bg-gray-600'}`}
              data-step={index}
            />
          )}
        </div>
      ))}
    </div>
    <div class="flex justify-between mt-2">
      {STEPS.map((step, index) => (
        <span
          class={`step-title text-xs font-medium ${index === 0 ? 'text-[var(--primary)]' : 'text-gray-400'}`}
          data-step={index}
        >
          {step.title}
        </span>
      ))}
    </div>
  </div>

  <!-- Step Content -->
  <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-6">
    <!-- Step 0: Occasion -->
    <div id="step-0" class="step-content">
      <h2 class="text-xl font-semibold mb-2">What's the occasion?</h2>
      <p class="text-gray-600 dark:text-gray-400 mb-4">
        Choose the type of celebration for your personalized song.
      </p>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        {OCCASIONS.map((occasion) => (
          <button
            type="button"
            class="occasion-btn flex flex-col items-center justify-center p-4 rounded-xl border-2 transition-all border-gray-200 dark:border-gray-600 hover:border-[var(--primary)]/50"
            data-value={occasion.value}
          >
            <span class="text-2xl mb-2">{occasion.emoji}</span>
            <span class="text-sm font-medium">{occasion.label}</span>
          </button>
        ))}
      </div>
    </div>

    <!-- Step 1: Recipients -->
    <div id="step-1" class="step-content hidden">
      <h2 class="text-xl font-semibold mb-2">Who is this gift for?</h2>
      <p class="text-gray-600 dark:text-gray-400 mb-4">
        Tell us about the lucky recipient and yourself.
      </p>
      <div class="space-y-4">
        <div>
          <label for="recipientName" class="block text-sm font-medium mb-1">Recipient's Name</label>
          <input
            id="recipientName"
            type="text"
            placeholder="e.g., Sarah, Dad, The Happy Couple"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent"
          />
        </div>
        <div>
          <label for="senderName" class="block text-sm font-medium mb-1">Your Name (the gift giver)</label>
          <input
            id="senderName"
            type="text"
            placeholder="e.g., John, The Smith Family"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent"
          />
        </div>
        <div>
          <label for="giftMessage" class="block text-sm font-medium mb-1">Personal Message (optional)</label>
          <textarea
            id="giftMessage"
            placeholder="Add a heartfelt message that will appear with the song..."
            rows="3"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent"
          ></textarea>
        </div>
      </div>
    </div>

    <!-- Step 2: Music -->
    <div id="step-2" class="step-content hidden">
      <div class="space-y-6">
        <div>
          <h2 class="text-xl font-semibold mb-2">What vibe should the song have?</h2>
          <p class="text-gray-600 dark:text-gray-400 mb-4">Choose the emotional tone for your personalized song.</p>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
            {VIBES.map((vibe) => (
              <button
                type="button"
                class="vibe-btn flex flex-col items-center justify-center p-4 rounded-xl border-2 transition-all border-gray-200 dark:border-gray-600 hover:border-[var(--primary)]/50"
                data-value={vibe.value}
              >
                <span class="text-2xl mb-2">{vibe.emoji}</span>
                <span class="text-sm font-medium">{vibe.label}</span>
              </button>
            ))}
          </div>
        </div>
        <div>
          <h2 class="text-xl font-semibold mb-2">What music style?</h2>
          <p class="text-gray-600 dark:text-gray-400 mb-4">Pick a genre that suits the recipient.</p>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
            {STYLES.map((style) => (
              <button
                type="button"
                class="style-btn flex flex-col items-center justify-center p-4 rounded-xl border-2 transition-all border-gray-200 dark:border-gray-600 hover:border-[var(--primary)]/50"
                data-value={style.value}
              >
                <span class="text-2xl mb-2">{style.emoji}</span>
                <span class="text-sm font-medium">{style.label}</span>
              </button>
            ))}
          </div>
        </div>
        <div>
          <h2 class="text-xl font-semibold mb-2">Voice preference</h2>
          <p class="text-gray-600 dark:text-gray-400 mb-4">Choose the vocal style for your song.</p>
          <div class="flex gap-3">
            {VOCALS.map((vocal) => (
              <button
                type="button"
                class="vocal-btn flex-1 flex items-center justify-center gap-2 p-4 rounded-xl border-2 transition-all border-gray-200 dark:border-gray-600 hover:border-[var(--primary)]/50"
                data-value={vocal.value}
              >
                <span class="text-xl">{vocal.emoji}</span>
                <span class="font-medium">{vocal.label}</span>
              </button>
            ))}
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3: Details -->
    <div id="step-3" class="step-content hidden">
      <h2 class="text-xl font-semibold mb-2">Tell us about the song</h2>
      <p class="text-gray-600 dark:text-gray-400 mb-4">
        The more details you provide, the more personalized your song will be!
      </p>
      <div class="space-y-4">
        <div>
          <label for="songFocus" class="block text-sm font-medium mb-1">What should the song be about?</label>
          <textarea
            id="songFocus"
            placeholder="e.g., Celebrating Sarah's 30th birthday and her love of adventure..."
            rows="3"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent"
          ></textarea>
        </div>
        <div>
          <label for="personalDetails" class="block text-sm font-medium mb-1">Personal details to include (optional)</label>
          <textarea
            id="personalDetails"
            placeholder="e.g., She loves hiking, her dog Max, and making everyone laugh. Her favorite memory is our trip to Hawaii..."
            rows="4"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent"
          ></textarea>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
            Include names, memories, inside jokes, or anything that makes this person special.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation Buttons -->
  <div class="flex justify-between">
    <button
      id="back-btn"
      class="px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
      disabled
    >
      â† Back
    </button>

    <button
      id="next-btn"
      class="px-6 py-2 bg-[var(--primary)] hover:bg-[var(--primary)]/90 text-white rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
      disabled
    >
      Next â†’
    </button>

    <button
      id="submit-btn"
      class="px-6 py-2 bg-[var(--primary)] hover:bg-[var(--primary)]/90 text-white rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-colors hidden"
      disabled
    >
      <span class="flex items-center gap-2">
        <span>ğŸ</span>
        Continue to Payment
      </span>
    </button>
  </div>

  <!-- Price Info -->
  <div class="mt-6 text-center text-sm text-gray-600 dark:text-gray-400">
    <p>Create 3 unique song variations to choose from</p>
  </div>
</div>

<script>
  const STORAGE_KEY = 'yourbanger-form-draft'
  const APP_URL = 'https://app.yourbanger.com'
  
  let currentStep = 0
  const formData = {
    occasion: '',
    recipientName: '',
    senderName: '',
    giftMessage: '',
    vibe: '',
    style: '',
    vocalGender: 'm',
    songFocus: '',
    personalDetails: '',
  }

  // Check for saved data on load
  function checkSavedData() {
    const saved = localStorage.getItem(STORAGE_KEY)
    if (saved) {
      try {
        const parsed = JSON.parse(saved)
        const age = Date.now() - parsed.timestamp
        if (age < 7 * 24 * 60 * 60 * 1000) {
          document.getElementById('restore-prompt')?.classList.remove('hidden')
        } else {
          localStorage.removeItem(STORAGE_KEY)
        }
      } catch {
        localStorage.removeItem(STORAGE_KEY)
      }
    }
  }

  // Auto-save with debouncing
  let saveTimeout: NodeJS.Timeout
  function autoSave() {
    clearTimeout(saveTimeout)
    saveTimeout = setTimeout(() => {
      if (Object.values(formData).some(v => v !== '' && v !== 'm')) {
        const saveData = {
          data: formData,
          currentStep,
          timestamp: Date.now(),
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData))
      }
    }, 500)
  }

  // Restore saved data
  document.getElementById('restore-btn')?.addEventListener('click', () => {
    const saved = localStorage.getItem(STORAGE_KEY)
    if (saved) {
      try {
        const parsed = JSON.parse(saved)
        Object.assign(formData, parsed.data)
        currentStep = parsed.currentStep || 0
        restoreFormUI()
        document.getElementById('restore-prompt')?.classList.add('hidden')
      } catch (e) {
        console.error('Failed to restore data:', e)
      }
    }
  })

  document.getElementById('dismiss-btn')?.addEventListener('click', () => {
    localStorage.removeItem(STORAGE_KEY)
    document.getElementById('restore-prompt')?.classList.add('hidden')
  })

  // Restore form UI from data
  function restoreFormUI() {
    // Restore text inputs
    const inputs = ['recipientName', 'senderName', 'giftMessage', 'songFocus', 'personalDetails']
    inputs.forEach(id => {
      const el = document.getElementById(id) as HTMLInputElement | HTMLTextAreaElement
      if (el && formData[id as keyof typeof formData]) {
        el.value = formData[id as keyof typeof formData] as string
      }
    })

    // Restore button selections
    if (formData.occasion) {
      document.querySelector(`.occasion-btn[data-value="${formData.occasion}"]`)?.classList.add('border-[var(--primary)]', 'bg-[var(--primary)]/10')
    }
    if (formData.vibe) {
      document.querySelector(`.vibe-btn[data-value="${formData.vibe}"]`)?.classList.add('border-[var(--primary)]', 'bg-[var(--primary)]/10')
    }
    if (formData.style) {
      document.querySelector(`.style-btn[data-value="${formData.style}"]`)?.classList.add('border-[var(--primary)]', 'bg-[var(--primary)]/10')
    }
    if (formData.vocalGender) {
      document.querySelector(`.vocal-btn[data-value="${formData.vocalGender}"]`)?.classList.add('border-[var(--primary)]', 'bg-[var(--primary)]/10')
    }

    updateStep(currentStep)
  }

  // Update step visibility
  function updateStep(step: number) {
    currentStep = step
    
    // Hide all steps
    document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'))
    // Show current step
    document.getElementById(`step-${step}`)?.classList.remove('hidden')

    // Update progress indicators
    document.querySelectorAll('.step-indicator').forEach((el, i) => {
      if (i <= step) {
        el.classList.add('border-[var(--primary)]', 'bg-[var(--primary)]', 'text-white')
        el.classList.remove('border-gray-300', 'dark:border-gray-600', 'bg-white', 'dark:bg-gray-800', 'text-gray-400')
      } else {
        el.classList.remove('border-[var(--primary)]', 'bg-[var(--primary)]', 'text-white')
        el.classList.add('border-gray-300', 'dark:border-gray-600', 'bg-white', 'dark:bg-gray-800', 'text-gray-400')
      }
    })

    document.querySelectorAll('.step-line').forEach((el, i) => {
      if (i < step) {
        el.classList.add('bg-[var(--primary)]')
        el.classList.remove('bg-gray-300', 'dark:bg-gray-600')
      } else {
        el.classList.remove('bg-[var(--primary)]')
        el.classList.add('bg-gray-300', 'dark:bg-gray-600')
      }
    })

    document.querySelectorAll('.step-title').forEach((el, i) => {
      if (i <= step) {
        el.classList.add('text-[var(--primary)]')
        el.classList.remove('text-gray-400')
      } else {
        el.classList.remove('text-[var(--primary)]')
        el.classList.add('text-gray-400')
      }
    })

    // Update buttons
    const backBtn = document.getElementById('back-btn') as HTMLButtonElement
    const nextBtn = document.getElementById('next-btn') as HTMLButtonElement
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement

    backBtn.disabled = step === 0
    
    if (step === 3) {
      nextBtn.classList.add('hidden')
      submitBtn.classList.remove('hidden')
    } else {
      nextBtn.classList.remove('hidden')
      submitBtn.classList.add('hidden')
    }

    validateStep()
  }

  // Validate current step
  function validateStep() {
    const nextBtn = document.getElementById('next-btn') as HTMLButtonElement
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement
    
    let isValid = false
    switch (currentStep) {
      case 0: isValid = !!formData.occasion; break
      case 1: isValid = !!formData.recipientName && !!formData.senderName; break
      case 2: isValid = !!formData.vibe && !!formData.style; break
      case 3: isValid = !!formData.songFocus; break
    }

    if (currentStep === 3) {
      submitBtn.disabled = !isValid
    } else {
      nextBtn.disabled = !isValid
    }
  }

  // Event listeners for form inputs
  document.querySelectorAll('.occasion-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLElement
      document.querySelectorAll('.occasion-btn').forEach(b => {
        b.classList.remove('border-[var(--primary)]', 'bg-[var(--primary)]/10', 'shadow-md')
        b.classList.add('border-gray-200', 'dark:border-gray-600')
      })
      target.classList.add('border-[var(--primary)]', 'bg-[var(--primary)]/10', 'shadow-md')
      target.classList.remove('border-gray-200', 'dark:border-gray-600')
      formData.occasion = target.dataset.value || ''
      autoSave()
      validateStep()
    })
  })

  document.querySelectorAll('.vibe-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLElement
      document.querySelectorAll('.vibe-btn').forEach(b => {
        b.classList.remove('border-[var(--primary)]', 'bg-[var(--primary)]/10', 'shadow-md')
        b.classList.add('border-gray-200', 'dark:border-gray-600')
      })
      target.classList.add('border-[var(--primary)]', 'bg-[var(--primary)]/10', 'shadow-md')
      target.classList.remove('border-gray-200', 'dark:border-gray-600')
      formData.vibe = target.dataset.value || ''
      autoSave()
      validateStep()
    })
  })

  document.querySelectorAll('.style-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLElement
      document.querySelectorAll('.style-btn').forEach(b => {
        b.classList.remove('border-[var(--primary)]', 'bg-[var(--primary)]/10', 'shadow-md')
        b.classList.add('border-gray-200', 'dark:border-gray-600')
      })
      target.classList.add('border-[var(--primary)]', 'bg-[var(--primary)]/10', 'shadow-md')
      target.classList.remove('border-gray-200', 'dark:border-gray-600')
      formData.style = target.dataset.value || ''
      autoSave()
      validateStep()
    })
  })

  document.querySelectorAll('.vocal-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLElement
      document.querySelectorAll('.vocal-btn').forEach(b => {
        b.classList.remove('border-[var(--primary)]', 'bg-[var(--primary)]/10')
        b.classList.add('border-gray-200', 'dark:border-gray-600')
      })
      target.classList.add('border-[var(--primary)]', 'bg-[var(--primary)]/10')
      target.classList.remove('border-gray-200', 'dark:border-gray-600')
      formData.vocalGender = target.dataset.value as 'm' | 'f' || 'm'
      autoSave()
      validateStep()
    })
  })

  // Text inputs
  const textInputs = ['recipientName', 'senderName', 'giftMessage', 'songFocus', 'personalDetails']
  textInputs.forEach(id => {
    const el = document.getElementById(id) as HTMLInputElement | HTMLTextAreaElement
    el?.addEventListener('input', (e) => {
      formData[id as keyof typeof formData] = (e.target as HTMLInputElement).value
      autoSave()
      validateStep()
    })
  })

  // Navigation
  document.getElementById('back-btn')?.addEventListener('click', () => {
    if (currentStep > 0) {
      updateStep(currentStep - 1)
    }
  })

  document.getElementById('next-btn')?.addEventListener('click', () => {
    if (currentStep < 3) {
      updateStep(currentStep + 1)
    }
  })

  document.getElementById('submit-btn')?.addEventListener('click', () => {
    // Save for transfer
    const transferData = {
      data: formData,
      timestamp: Date.now(),
      transferred: false,
    }
    localStorage.setItem('song-form-transfer', JSON.stringify(transferData))
    localStorage.removeItem(STORAGE_KEY)
    
    // Redirect to app
    window.location.href = `${APP_URL}/auth?tab=signup&from=create`
  })

  // Initialize
  checkSavedData()
  validateStep()
</script>
