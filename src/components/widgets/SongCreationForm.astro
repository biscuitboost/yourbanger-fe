---
const ARTIST_PERSONAS = [
  { id: 'milo', slug: 'heartfelt-acoustic', name: 'Milo', avatar: 'üé∏', genreLabel: 'Acoustic Folk', tagline: 'Warm, intimate, and deeply personal', gender: 'm', color: 'amber' },
  { id: 'jada', slug: 'romantic-rnb', name: 'Jada', avatar: 'üé§', genreLabel: 'R&B Soul', tagline: 'Smooth, soulful, and passionate', gender: 'f', color: 'rose' },
  { id: 'axel', slug: 'uplifting-rock', name: 'Axel', avatar: 'üé∏', genreLabel: 'Pop Rock', tagline: 'Energetic, anthemic, and powerful', gender: 'm', color: 'orange' },
  { id: 'luna', slug: 'nostalgic-pop', name: 'Luna', avatar: '‚ú®', genreLabel: 'Indie Pop', tagline: 'Dreamy, reflective, and bittersweet', gender: 'f', color: 'violet' },
  { id: 'marcus', slug: 'celebratory-hiphop', name: 'Marcus', avatar: 'üéß', genreLabel: 'Hip-Hop', tagline: 'Fresh, confident, and triumphant', gender: 'm', color: 'emerald' },
  { id: 'bella', slug: 'sentimental-country', name: 'Bella', avatar: 'ü§†', genreLabel: 'Country', tagline: 'Storytelling with heart and soul', gender: 'f', color: 'yellow' },
  { id: 'kai', slug: 'chill-lofi', name: 'Kai', avatar: 'üåô', genreLabel: 'Lo-Fi Chill', tagline: 'Laid-back, cozy, and mellow', gender: 'm', color: 'sky' },
  { id: 'nova', slug: 'empowering-pop', name: 'Nova', avatar: 'üí´', genreLabel: 'Pop', tagline: 'Bold, catchy, and inspirational', gender: 'f', color: 'pink' },
]

// 12 Custom Power Pairings
const CUSTOM_PAIRINGS = [
  { id: 'acoustic-sentimental', slug: 'sentimental-acoustic', label: 'Acoustic Sentimental', emoji: 'üé∏', description: 'Tender and nostalgic', gender: 'm' },
  { id: 'pop-uplifting', slug: 'uplifting-pop', label: 'Pop Uplifting', emoji: 'üé§', description: 'Feel-good and catchy', gender: 'f' },
  { id: 'rnb-romantic', slug: 'romantic-rnb', label: 'R&B Romantic', emoji: 'üíú', description: 'Smooth and passionate', gender: 'f' },
  { id: 'country-heartfelt', slug: 'heartfelt-country', label: 'Country Heartfelt', emoji: 'ü§†', description: 'Storytelling with soul', gender: 'f' },
  { id: 'rock-energetic', slug: 'celebratory-rock', label: 'Rock Energetic', emoji: 'üé∏', description: 'Powerful and anthemic', gender: 'm' },
  { id: 'soul-emotional', slug: 'bittersweet-soul', label: 'Soul Emotional', emoji: 'üé∑', description: 'Deep and moving', gender: 'f' },
  { id: 'indie-dreamy', slug: 'nostalgic-indie', label: 'Indie Dreamy', emoji: 'üåø', description: 'Quirky and reflective', gender: 'f' },
  { id: 'hiphop-celebratory', slug: 'celebratory-hiphop', label: 'Hip-Hop Celebratory', emoji: 'üéß', description: 'Fresh and triumphant', gender: 'm' },
  { id: 'folk-nostalgic', slug: 'nostalgic-folk', label: 'Folk Nostalgic', emoji: 'üåæ', description: 'Earthy and timeless', gender: 'm' },
  { id: 'synth-retro', slug: 'nostalgic-synth-pop', label: 'Synth Retro', emoji: 'üåå', description: '80s-inspired vibes', gender: 'm' },
  { id: 'jazz-romantic', slug: 'romantic-jazz', label: 'Jazz Romantic', emoji: 'üé∫', description: 'Sophisticated and smooth', gender: 'm' },
  { id: 'pop-funny', slug: 'funny-pop', label: 'Pop Playful', emoji: 'üòÑ', description: 'Light and entertaining', gender: 'f' },
]

const STEPS = [
  { id: 'occasion', title: 'Occasion', icon: 'üéÅ' },
  { id: 'recipients', title: 'Recipients', icon: '‚ú®' },
  { id: 'music', title: 'Music Style', icon: 'üéµ' },
  { id: 'details', title: 'Song Details', icon: '‚ú®' },
]

interface Occasion {
  value: string
  label: string
  emoji: string
  description: string
  category: 'year_round' | 'seasonal'
  priority: number
}

const ALL_OCCASIONS: Occasion[] = [
  // Year-round occasions
  { value: 'birthday', label: 'Birthday', emoji: 'üéÇ', description: 'Celebrate their special day', category: 'year_round', priority: 1 },
  { value: 'just_because', label: 'Just Because', emoji: 'üí≠', description: 'No occasion needed', category: 'year_round', priority: 2 },
  { value: 'thank_you', label: 'Thank You', emoji: 'üôè', description: 'Show your appreciation', category: 'year_round', priority: 3 },
  { value: 'wedding', label: 'Wedding', emoji: 'üíí', description: 'Your perfect wedding song', category: 'year_round', priority: 4 },
  { value: 'anniversary', label: 'Anniversary', emoji: 'üíç', description: 'Honor your love story', category: 'year_round', priority: 5 },
  { value: 'new_baby', label: 'New Baby', emoji: 'üë∂', description: 'Welcome the little one', category: 'year_round', priority: 6 },
  { value: 'get_well', label: 'Get Well', emoji: 'üíê', description: 'Wish them a speedy recovery', category: 'year_round', priority: 7 },
  { value: 'congratulations', label: 'Congratulations', emoji: 'üéä', description: 'Celebrate their achievement', category: 'year_round', priority: 8 },
  { value: 'graduation', label: 'Graduation', emoji: 'üéì', description: 'Honor their hard work', category: 'year_round', priority: 9 },
  { value: 'retirement', label: 'Retirement', emoji: 'üèñÔ∏è', description: 'Celebrate their career', category: 'year_round', priority: 10 },
  { value: 'memorial', label: 'In Memory', emoji: 'üïäÔ∏è', description: 'Honor their memory', category: 'year_round', priority: 11 },
  
  // Seasonal occasions (always shown for marketing site)
  { value: 'christmas', label: 'Christmas', emoji: 'üéÑ', description: 'Holiday cheer in song', category: 'seasonal', priority: 1 },
  { value: 'valentines', label: "Valentine's Day", emoji: '‚ù§Ô∏è', description: 'Express your love', category: 'seasonal', priority: 2 },
  { value: 'mothers_day', label: "Mother's Day", emoji: 'üå∏', description: 'Thank Mom', category: 'seasonal', priority: 3 },
  { value: 'fathers_day', label: "Father's Day", emoji: 'üëî', description: 'Thank Dad', category: 'seasonal', priority: 4 },
  { value: 'thanksgiving', label: 'Thanksgiving', emoji: 'ü¶É', description: 'Give thanks', category: 'seasonal', priority: 5 },
  { value: 'new_year', label: 'New Year', emoji: 'üéâ', description: 'Ring in the new year', category: 'seasonal', priority: 6 },
]

const OCCASIONS = ALL_OCCASIONS.sort((a, b) => a.priority - b.priority)

---

<div class="max-w-2xl mx-auto" id="song-form">
  <!-- Restore Prompt (hidden by default, shown by JS) -->
  <div id="restore-prompt" class="mb-6 p-4 bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-800 rounded-lg hidden">
    <div class="flex items-start gap-3">
      <span class="text-2xl">üíæ</span>
      <div class="flex-1">
        <h3 class="font-semibold text-blue-900 dark:text-blue-100 mb-1">
          Continue where you left off?
        </h3>
        <p class="text-sm text-blue-700 dark:text-blue-300 mb-3">
          We found your previous song creation progress.
        </p>
        <div class="flex gap-2">
          <button
            id="restore-btn"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors"
          >
            Restore Progress
          </button>
          <button
            id="dismiss-btn"
            class="px-4 py-2 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 text-sm font-medium rounded-lg border border-gray-300 dark:border-gray-600 transition-colors"
          >
            Start Fresh
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Progress Steps -->
  <div class="mb-8">
    <div class="flex justify-between items-center">
      {STEPS.map((step, index) => (
        <div class="flex items-center">
          <div
            class={`step-indicator flex items-center justify-center w-10 h-10 rounded-full border-2 transition-colors ${
              index === 0 ? 'border-[var(--primary)] bg-[var(--primary)] text-white' : 'border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-400'
            }`}
            data-step={index}
          >
            <span class="text-lg">{step.icon}</span>
          </div>
          {index < STEPS.length - 1 && (
            <div
              class={`step-line w-[60px] h-1 mx-2 ${index === 0 ? 'bg-gray-300 dark:bg-gray-600' : 'bg-gray-300 dark:bg-gray-600'}`}
              data-step={index}
            />
          )}
        </div>
      ))}
    </div>
    <div class="flex justify-between mt-2">
      {STEPS.map((step, index) => (
        <span
          class={`step-title text-xs font-medium ${index === 0 ? 'text-[var(--primary)]' : 'text-gray-400'}`}
          data-step={index}
        >
          {step.title}
        </span>
      ))}
    </div>
  </div>

  <!-- Step Content -->
  <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-6">
    <!-- Step 0: Occasion -->
    <div id="step-0" class="step-content">
      <h2 class="text-xl font-semibold mb-2">What's the occasion?</h2>
      <p class="text-gray-600 dark:text-gray-400 mb-4">
        Choose the type of celebration for your personalized song.
      </p>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        {OCCASIONS.map((occasion) => (
          <button
            type="button"
            class="occasion-btn flex flex-col items-center justify-center p-4 rounded-xl border-2 transition-all border-gray-200 dark:border-gray-600 hover:border-[var(--primary)]/50"
            data-value={occasion.value}
          >
            <span class="text-2xl mb-2">{occasion.emoji}</span>
            <span class="text-sm font-medium">{occasion.label}</span>
          </button>
        ))}
      </div>
    </div>

    <!-- Step 1: Recipients -->
    <div id="step-1" class="step-content hidden">
      <h2 class="text-xl font-semibold mb-2">Who is this gift for?</h2>
      <p class="text-gray-600 dark:text-gray-400 mb-4">
        Tell us about the lucky recipient and yourself.
      </p>
      <div class="space-y-4">
        <div>
          <label for="recipientName" class="block text-sm font-medium mb-1">Recipient's Name</label>
          <input
            id="recipientName"
            type="text"
            placeholder="e.g., Sarah, Dad, The Happy Couple"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent"
          />
        </div>
        <div>
          <label for="senderName" class="block text-sm font-medium mb-1">Your Name (the gift giver)</label>
          <input
            id="senderName"
            type="text"
            placeholder="e.g., John, The Smith Family"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent"
          />
        </div>
        <div>
          <label for="giftMessage" class="block text-sm font-medium mb-1">Personal Message (optional)</label>
          <textarea
            id="giftMessage"
            placeholder="Add a heartfelt message that will appear with the song..."
            rows="3"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent"
          ></textarea>
        </div>
      </div>
    </div>

    <!-- Step 2: Music Style - Persona Selection -->
    <div id="step-2" class="step-content hidden">
      <div class="space-y-6">
        <!-- Section Header -->
        <div class="flex items-center gap-2">
          <span class="text-xl">‚ú®</span>
          <h2 class="text-xl font-semibold">Choose Your Artist</h2>
        </div>
        <p class="text-gray-600 dark:text-gray-400">Pick an artist persona or customize your own combination.</p>

        <!-- Artist Persona Grid - 2 cols mobile, 4 cols desktop -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
          {ARTIST_PERSONAS.map((persona) => (
            <button
              type="button"
              class="persona-btn relative flex flex-col items-center p-3 sm:p-4 rounded-xl border-2 transition-all duration-200 hover:shadow-md hover:scale-[1.02] min-h-[140px] sm:min-h-[160px] border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800 hover:border-[var(--primary)]/30"
              data-id={persona.id}
              data-slug={persona.slug}
              data-gender={persona.gender}
            >
              <div class="w-12 h-12 sm:w-14 sm:h-14 rounded-full flex items-center justify-center text-2xl sm:text-3xl mb-2 bg-gray-100 dark:bg-gray-700">
                {persona.avatar}
              </div>
              <p class="font-semibold text-sm sm:text-base">{persona.name}</p>
              <span class="text-[10px] sm:text-xs px-2 py-0.5 rounded-full mt-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
                {persona.genreLabel}
              </span>
              <p class="hidden sm:block text-xs text-gray-500 dark:text-gray-400 text-center mt-2 line-clamp-2">
                {persona.tagline}
              </p>
              <!-- Selection indicator (hidden by default) -->
              <div class="persona-check absolute top-2 right-2 hidden">
                <div class="w-5 h-5 rounded-full flex items-center justify-center border-2 border-[var(--primary)] bg-white dark:bg-gray-900">
                  <svg class="w-3 h-3 text-[var(--primary)]" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                  </svg>
                </div>
              </div>
            </button>
          ))}
        </div>

        <!-- Custom Option Toggle -->
        <div class="pt-2">
          <button
            type="button"
            id="custom-toggle"
            class="w-full flex items-center justify-between p-4 rounded-xl border-2 border-dashed border-gray-300 dark:border-gray-600 transition-all hover:border-[var(--primary)]/50"
          >
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-100 dark:bg-gray-700">
                <span class="text-lg">üéõÔ∏è</span>
              </div>
              <div class="text-left">
                <p class="font-medium">Custom Style</p>
                <p id="custom-subtitle" class="text-sm text-gray-500 dark:text-gray-400">Choose from 12 curated combinations</p>
              </div>
            </div>
            <span id="custom-chevron" class="text-gray-400">‚ñº</span>
          </button>

          <!-- Custom Pairings Panel (hidden by default) -->
          <div id="custom-panel" class="hidden mt-4 p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-200 dark:border-gray-700">
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
              {CUSTOM_PAIRINGS.map((pairing) => (
                <button
                  type="button"
                  class="custom-btn flex flex-col items-center gap-1 p-3 rounded-lg border transition-all text-center hover:border-[var(--primary)]/50 overflow-hidden border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700"
                  data-id={pairing.id}
                  data-slug={pairing.slug}
                  data-gender={pairing.gender}
                >
                  <span class="text-2xl">{pairing.emoji}</span>
                  <p class="text-xs sm:text-sm font-medium w-full">{pairing.label}</p>
                  <p class="text-[10px] text-gray-500 dark:text-gray-400 w-full">{pairing.description}</p>
                </button>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3: Details -->
    <div id="step-3" class="step-content hidden">
      <h2 class="text-xl font-semibold mb-2">Tell us about the song</h2>
      <p class="text-gray-600 dark:text-gray-400 mb-4">
        The more details you provide, the more personalized your song will be!
      </p>
      <div class="space-y-4">
        <div>
          <label for="songFocus" class="block text-sm font-medium mb-1">What should the song be about?</label>
          <textarea
            id="songFocus"
            placeholder="e.g., Celebrating Sarah's 30th birthday and her love of adventure..."
            rows="3"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent"
          ></textarea>
        </div>
        <div>
          <label for="personalDetails" class="block text-sm font-medium mb-1">Personal details to include (optional)</label>
          <textarea
            id="personalDetails"
            placeholder="e.g., She loves hiking, her dog Max, and making everyone laugh. Her favorite memory is our trip to Hawaii..."
            rows="4"
            class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900 focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent"
          ></textarea>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
            Include names, memories, inside jokes, or anything that makes this person special.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation Buttons -->
  <div class="flex justify-between">
    <button
      id="back-btn"
      class="px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
      disabled
    >
      ‚Üê Back
    </button>

    <button
      id="next-btn"
      class="px-6 py-2 bg-[var(--primary)] hover:bg-[var(--primary)]/90 text-white rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
      disabled
    >
      Next ‚Üí
    </button>

    <button
      id="submit-btn"
      class="px-6 py-2 bg-[var(--primary)] hover:bg-[var(--primary)]/90 text-white rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-colors hidden"
      disabled
    >
      <span class="flex items-center gap-2">
        <span>‚ú®</span>
        Create My Song!
      </span>
    </button>
  </div>

  <!-- Price Info -->
  <div class="mt-6 text-center text-sm text-gray-600 dark:text-gray-400">
    <p>Create 3 unique song variations to choose from</p>
  </div>
</div>

<script>
  const STORAGE_KEY = 'yourbanger-form-draft'
  const APP_URL = 'https://app.yourbanger.com'
  
  let currentStep = 0
  let showCustomPanel = false
  let saveTimeout: NodeJS.Timeout
  
  // New styleSelection format
  const formData = {
    occasion: '',
    recipientName: '',
    senderName: '',
    giftMessage: '',
    styleSelection: null as { type: 'persona' | 'custom'; id: string; slug: string; gender: 'm' | 'f' } | null,
    songFocus: '',
    personalDetails: '',
  }

  // Check for saved data on load
  function checkSavedData() {
    const saved = localStorage.getItem(STORAGE_KEY)
    if (saved) {
      try {
        const parsed = JSON.parse(saved)
        const age = Date.now() - parsed.timestamp
        if (age < 7 * 24 * 60 * 60 * 1000) {
          document.getElementById('restore-prompt')?.classList.remove('hidden')
        } else {
          localStorage.removeItem(STORAGE_KEY)
        }
      } catch {
        localStorage.removeItem(STORAGE_KEY)
      }
    }
  }

  function autoSave() {
    clearTimeout(saveTimeout)
    saveTimeout = setTimeout(() => {
      // Check if form has meaningful data (not empty strings, null styleSelection)
      const hasData = formData.occasion ||
                     formData.recipientName ||
                     formData.senderName ||
                     formData.giftMessage ||
                     formData.styleSelection ||
                     formData.songFocus ||
                     formData.personalDetails
      if (hasData) {
        const saveData = {
          data: formData,
          currentStep,
          timestamp: Date.now(),
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(saveData))
      }
    }, 500)
  }

  // Restore saved data
  document.getElementById('restore-btn')?.addEventListener('click', () => {
    const saved = localStorage.getItem(STORAGE_KEY)
    if (saved) {
      try {
        const parsed = JSON.parse(saved)
        Object.assign(formData, parsed.data)
        currentStep = parsed.currentStep || 0
        restoreFormUI()
        document.getElementById('restore-prompt')?.classList.add('hidden')
      } catch (e) {
        console.error('Failed to restore data:', e)
      }
    }
  })

  document.getElementById('dismiss-btn')?.addEventListener('click', () => {
    localStorage.removeItem(STORAGE_KEY)
    document.getElementById('restore-prompt')?.classList.add('hidden')
  })

  // Restore form UI from data
  function restoreFormUI() {
    // Restore text inputs
    const inputs = ['recipientName', 'senderName', 'giftMessage', 'songFocus', 'personalDetails']
    inputs.forEach(id => {
      const el = document.getElementById(id) as HTMLInputElement | HTMLTextAreaElement
      if (el && formData[id as keyof typeof formData]) {
        el.value = formData[id as keyof typeof formData] as string
      }
    })

    // Restore button selections
    if (formData.occasion) {
      document.querySelector(`.occasion-btn[data-value="${formData.occasion}"]`)?.classList.add('border-[var(--primary)]', 'bg-[var(--primary)]/10')
    }
    
    // Restore styleSelection
    if (formData.styleSelection) {
      if (formData.styleSelection.type === 'persona') {
        const btn = document.querySelector(`.persona-btn[data-id="${formData.styleSelection.id}"]`)
        btn?.classList.add('border-[var(--primary)]', 'bg-[var(--primary)]/10', 'shadow-lg', 'ring-2', 'ring-[var(--primary)]/20')
        btn?.querySelector('.persona-check')?.classList.remove('hidden')
      } else if (formData.styleSelection.type === 'custom') {
        const btn = document.querySelector(`.custom-btn[data-id="${formData.styleSelection.id}"]`)
        btn?.classList.add('border-[var(--primary)]', 'bg-[var(--primary)]/10', 'shadow-sm')
        const toggle = document.getElementById('custom-toggle')
        toggle?.classList.add('border-[var(--primary)]', 'bg-[var(--primary)]/5')
        toggle?.classList.remove('border-dashed')
        const label = btn?.querySelector('p.font-medium')?.textContent || ''
        document.getElementById('custom-subtitle')!.textContent = `Selected: ${label}`
      }
    }

    updateStep(currentStep)
  }

  // Update step visibility
  function updateStep(step: number) {
    currentStep = step
    
    // Hide all steps
    document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'))
    // Show current step
    document.getElementById(`step-${step}`)?.classList.remove('hidden')

    // Update progress indicators
    document.querySelectorAll('.step-indicator').forEach((el, i) => {
      if (i <= step) {
        el.classList.add('border-[var(--primary)]', 'bg-[var(--primary)]', 'text-white')
        el.classList.remove('border-gray-300', 'dark:border-gray-600', 'bg-white', 'dark:bg-gray-800', 'text-gray-400')
      } else {
        el.classList.remove('border-[var(--primary)]', 'bg-[var(--primary)]', 'text-white')
        el.classList.add('border-gray-300', 'dark:border-gray-600', 'bg-white', 'dark:bg-gray-800', 'text-gray-400')
      }
    })

    document.querySelectorAll('.step-line').forEach((el, i) => {
      if (i < step) {
        el.classList.add('bg-[var(--primary)]')
        el.classList.remove('bg-gray-300', 'dark:bg-gray-600')
      } else {
        el.classList.remove('bg-[var(--primary)]')
        el.classList.add('bg-gray-300', 'dark:bg-gray-600')
      }
    })

    document.querySelectorAll('.step-title').forEach((el, i) => {
      if (i <= step) {
        el.classList.add('text-[var(--primary)]')
        el.classList.remove('text-gray-400')
      } else {
        el.classList.remove('text-[var(--primary)]')
        el.classList.add('text-gray-400')
      }
    })

    // Update buttons
    const backBtn = document.getElementById('back-btn') as HTMLButtonElement
    const nextBtn = document.getElementById('next-btn') as HTMLButtonElement
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement

    backBtn.disabled = step === 0
    
    if (step === 3) {
      nextBtn.classList.add('hidden')
      submitBtn.classList.remove('hidden')
    } else {
      nextBtn.classList.remove('hidden')
      submitBtn.classList.add('hidden')
    }

    validateStep()
  }

  // Validate current step
  function validateStep() {
    const nextBtn = document.getElementById('next-btn') as HTMLButtonElement
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement
    
    let isValid = false
    switch (currentStep) {
      case 0: isValid = !!formData.occasion; break
      case 1: isValid = !!formData.recipientName && !!formData.senderName; break
      case 2: isValid = !!formData.styleSelection; break
      case 3: isValid = !!formData.songFocus; break
    }

    if (currentStep === 3) {
      submitBtn.disabled = !isValid
    } else {
      nextBtn.disabled = !isValid
    }
  }

  // Event listeners for form inputs
  document.querySelectorAll('.occasion-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLElement
      document.querySelectorAll('.occasion-btn').forEach(b => {
        b.classList.remove('border-[var(--primary)]', 'bg-[var(--primary)]/10', 'shadow-md')
        b.classList.add('border-gray-200', 'dark:border-gray-600')
      })
      target.classList.add('border-[var(--primary)]', 'bg-[var(--primary)]/10', 'shadow-md')
      target.classList.remove('border-gray-200', 'dark:border-gray-600')
      formData.occasion = target.dataset.value || ''
      autoSave()
      validateStep()
    })
  })

  // Persona selection
  document.querySelectorAll('.persona-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLElement
      
      // Clear all persona selections
      document.querySelectorAll('.persona-btn').forEach(b => {
        b.classList.remove('border-[var(--primary)]', 'bg-[var(--primary)]/10', 'shadow-lg', 'ring-2', 'ring-[var(--primary)]/20')
        b.classList.add('border-gray-200', 'dark:border-gray-600')
        b.querySelector('.persona-check')?.classList.add('hidden')
      })
      
      // Clear custom selections
      document.querySelectorAll('.custom-btn').forEach(b => {
        b.classList.remove('border-[var(--primary)]', 'bg-[var(--primary)]/10', 'shadow-sm')
        b.classList.add('border-gray-200', 'dark:border-gray-600')
      })
      document.getElementById('custom-toggle')?.classList.remove('border-[var(--primary)]', 'bg-[var(--primary)]/5')
      document.getElementById('custom-toggle')?.classList.add('border-dashed', 'border-gray-300', 'dark:border-gray-600')
      document.getElementById('custom-subtitle')!.textContent = 'Choose from 12 curated combinations'
      
      // Select this persona
      target.classList.add('border-[var(--primary)]', 'bg-[var(--primary)]/10', 'shadow-lg', 'ring-2', 'ring-[var(--primary)]/20')
      target.classList.remove('border-gray-200', 'dark:border-gray-600')
      target.querySelector('.persona-check')?.classList.remove('hidden')
      
      // Close custom panel
      showCustomPanel = false
      document.getElementById('custom-panel')?.classList.add('hidden')
      document.getElementById('custom-chevron')!.textContent = '‚ñº'
      
      // Update form data
      formData.styleSelection = {
        type: 'persona',
        id: target.dataset.id || '',
        slug: target.dataset.slug || '',
        gender: (target.dataset.gender as 'm' | 'f') || 'm',
      }
      autoSave()
      validateStep()
    })
  })

  // Custom toggle
  document.getElementById('custom-toggle')?.addEventListener('click', () => {
    showCustomPanel = !showCustomPanel
    const panel = document.getElementById('custom-panel')
    const chevron = document.getElementById('custom-chevron')
    
    if (showCustomPanel) {
      panel?.classList.remove('hidden')
      chevron!.textContent = '‚ñ≤'
    } else {
      panel?.classList.add('hidden')
      chevron!.textContent = '‚ñº'
    }
  })

  // Custom pairing selection
  document.querySelectorAll('.custom-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLElement
      
      // Clear all persona selections
      document.querySelectorAll('.persona-btn').forEach(b => {
        b.classList.remove('border-[var(--primary)]', 'bg-[var(--primary)]/10', 'shadow-lg', 'ring-2', 'ring-[var(--primary)]/20')
        b.classList.add('border-gray-200', 'dark:border-gray-600')
        b.querySelector('.persona-check')?.classList.add('hidden')
      })
      
      // Clear other custom selections
      document.querySelectorAll('.custom-btn').forEach(b => {
        b.classList.remove('border-[var(--primary)]', 'bg-[var(--primary)]/10', 'shadow-sm')
        b.classList.add('border-gray-200', 'dark:border-gray-600')
      })
      
      // Select this custom pairing
      target.classList.add('border-[var(--primary)]', 'bg-[var(--primary)]/10', 'shadow-sm')
      target.classList.remove('border-gray-200', 'dark:border-gray-600')
      
      // Update custom toggle to show selected
      const toggle = document.getElementById('custom-toggle')
      toggle?.classList.add('border-[var(--primary)]', 'bg-[var(--primary)]/5')
      toggle?.classList.remove('border-dashed', 'border-gray-300', 'dark:border-gray-600')
      
      // Find the label for this pairing
      const label = target.querySelector('p.font-medium')?.textContent || ''
      document.getElementById('custom-subtitle')!.textContent = `Selected: ${label}`
      
      // Update form data
      formData.styleSelection = {
        type: 'custom',
        id: target.dataset.id || '',
        slug: target.dataset.slug || '',
        gender: (target.dataset.gender as 'm' | 'f') || 'm',
      }
      autoSave()
      validateStep()
    })
  })

  // Text inputs
  const textInputs = ['recipientName', 'senderName', 'giftMessage', 'songFocus', 'personalDetails']
  textInputs.forEach(id => {
    const el = document.getElementById(id) as HTMLInputElement | HTMLTextAreaElement
    el?.addEventListener('input', (e) => {
      (formData as any)[id] = (e.target as HTMLInputElement).value
      autoSave()
      validateStep()
    })
  })

  // Navigation
  document.getElementById('back-btn')?.addEventListener('click', () => {
    if (currentStep > 0) {
      updateStep(currentStep - 1)
    }
  })

  document.getElementById('next-btn')?.addEventListener('click', () => {
    if (currentStep < 3) {
      updateStep(currentStep + 1)
    }
  })

  document.getElementById('submit-btn')?.addEventListener('click', () => {
    // Encode form data as base64 to pass via URL (localStorage doesn't work cross-domain)
    const transferData = {
      occasion: formData.occasion,
      recipientName: formData.recipientName,
      senderName: formData.senderName,
      giftMessage: formData.giftMessage,
      styleSelection: formData.styleSelection,
      songFocus: formData.songFocus,
      personalDetails: formData.personalDetails,
    }
    const encoded = btoa(encodeURIComponent(JSON.stringify(transferData)))
    localStorage.removeItem(STORAGE_KEY)
    
    // Redirect to app auth page with signup tab and form data
    window.location.href = `${APP_URL}/auth?tab=signup&from=create&formData=${encoded}`
  })

  // Initialize
  checkSavedData()
  validateStep()
</script>
